create table Caja.MontoInicialCaja
(
IdCaja int primary key not null,
MontoInicialCaja decimal(20,2)
)

insert into Caja.MontoInicialCaja (IdCaja,MontoInicialCaja) values (1,0)

CREATE PROCEDURE [Caja].[SP_BUSCAR_MONTO_INICIAL_CAJA]
@IdCaja INT = 1

AS

SELECT
  MI.IdCaja
, MI.MontoInicialCaja
FROM [Caja].[MontoInicialCaja] MI

WHERE MI.IdCaja = ISNULL(@IdCaja,MI.IdCaja)

CREATE PROCEDURE [Caja].[SP_MODIFICAR_MONTO_INICIAL_CAJA]
  @IdCaja INT
, @MontoInicialCaja DECIMAL(20,2)
, @Accion VARCHAR(150) = 'UPDATE'

AS

DECLARE @ITEMS TABLE
(
  IdCaja INT
, MontoInicialCaja DECIMAL(20,2)
)

IF(@Accion='UPDATE')
	
	BEGIN
		
		UPDATE [Caja].[MontoInicialCaja] SET
			
			MontoInicialCaja = @MontoInicialCaja
				
				OUTPUT
					
					  inserted.IdCaja
					, inserted.MontoInicialCaja
						
						INTO @ITEMS
							
							WHERE IdCaja = @IdCaja
END
SELECT * FROM @ITEMS

------------------------------------------------------------------------------------------------------------------------------------------

create table Caja.HistorialCierreCaja
(
IdHistirualCierreCaja decimal(20,0) primary key not null,
IdUsuario decimal(20,0),
FechaCierre date,
MontoAntesCerrar decimal(20,2),
MontoDespuesCierre decimal(20,2),
ConceptoCierre varchar(100)
)

CREATE PROCEDURE [Caja].[SP_BUSCA_HISTORIAL_CIERRE_CAJA]
  @IdHistorialCierreCaja DECIMAL(20,0) = NULL
, @IdUsuario DECIMAL(20,0) = NULL
, @FechaCierreDesde DATE = NULL
, @FechaCierreHasta DATE = NULL
, @NumeroPagina INT = 1
, @NumeroRegistros INT = 10

AS

SELECT
  H.IdHistirualCierreCaja
, H.IdUsuario
, UPPER(UC.Persona) AS CerradoPor
, H.FechaCierre AS FechaCierre0 
, FORMAT(H.FechaCierre,'dd/MM/yyyy') AS FechaCierre
, H.MontoAntesCerrar
, H.MontoDespuesCierre
, UPPER(H.ConceptoCierre) AS ConceptoCierre
FROM [Caja].[HistorialCierreCaja] H
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = H.IdUsuario
WHERE H.IdHistirualCierreCaja = ISNULL(@IdHistorialCierreCaja,H.IdHistirualCierreCaja)
AND H.IdUsuario = ISNULL(@IdUsuario,H.IdUsuario)
AND (
H.FechaCierre >= ISNULL(@FechaCierreDesde,H.FechaCierre)
AND H.FechaCierre <= ISNULL(@FechaCierreHasta,H.FechaCierre)
)

ORDER BY H.IdHistirualCierreCaja
OFFSET(@NumeroPagina -1) * @NumeroRegistros ROWS
FETCH NEXT @NumeroRegistros ROWS ONLY;



CREATE PROCEDURE [Caja].[SP_MANTENIMIENTO_HISTORIAL_CIERRE_CAJA]
  @IdHistorialCierreCaja DECIMAL(20,0)
, @IdUsuario DECIMAL(20,0)
, @MontoAntesCerrar DECIMAL(20,2)
, @MontoDespuesCerrar DECIMAL(20,2)
, @ConceptoCierre VARCHAR(100)
, @Accion VARCHAR(150) = 'INSERT'

AS

DECLARE @ITEMS TABLE
(
  IdHistorialCierreCaja DECIMAL(20,0)
, IdUsuario DECIMAL(20,0)
, FechaCierre DATE
, MontoAntesCerrar DECIMAL(20,2)
, MontoDespuesCerrar DECIMAL(20,2)
, ConceptoCierre VARCHAR(100)
)

IF(@Accion='INSERT')
	
	BEGIN
		
		SELECT
		@IdHistorialCierreCaja = ISNULL(MAX(IdHistirualCierreCaja),0) + 1
		FROM [Caja].[HistorialCierreCaja]
		IF(ISNULL(@IdHistorialCierreCaja,0) = 0)
		SET @IdHistorialCierreCaja = 1
			
			INSERT INTO [Caja].[HistorialCierreCaja]
			(
				  IdHistirualCierreCaja
				, IdUsuario
				, FechaCierre
				, MontoAntesCerrar
				, MontoDespuesCierre
				, ConceptoCierre
			)
				
				OUTPUT
					
					  inserted.IdHistirualCierreCaja
					, inserted.IdUsuario
					, inserted.FechaCierre
					, inserted.MontoAntesCerrar
					, inserted.MontoDespuesCierre
					, inserted.ConceptoCierre
						
						INTO @ITEMS
							
							VALUES
							(
								  @IdHistorialCierreCaja
								, @IdUsuario
								, GETDATE()
								, @MontoAntesCerrar
								, @MontoDespuesCerrar
								, @ConceptoCierre
							)
END

IF(@Accion='DELETE')
	
	BEGIN
		
		DELETE FROM [Caja].[HistorialCierreCaja]
			
			OUTPUT
				
				  deleted.IdHistirualCierreCaja
				, deleted.IdUsuario
				, deleted.FechaCierre
				, deleted.MontoAntesCerrar
				, deleted.MontoDespuesCierre
				, deleted.ConceptoCierre
					
					INTO @ITEMS
						
						WHERE IdHistirualCierreCaja = @IdHistorialCierreCaja
END

IF(@Accion='DELETEALL')
	
	BEGIN
		
		DELETE FROM [Caja].[HistorialCierreCaja]
			
			OUTPUT
				
				  deleted.IdHistirualCierreCaja
				, deleted.IdUsuario
				, deleted.FechaCierre
				, deleted.MontoAntesCerrar
				, deleted.MontoDespuesCierre
				, deleted.ConceptoCierre
					
					INTO @ITEMS
						
					---	WHERE IdHistirualCierreCaja = @IdHistorialCierreCaja
END
SELECT * FROM @ITEMS


---------------------------------------------------------------------------------------------------------------------------------------


alter table Empresa.TipoBienesServicio add Codigo varchar(2)


update Empresa.TipoBienesServicio set Codigo = '01' where IdTipoBienesServicio = 1
update Empresa.TipoBienesServicio set Codigo = '02' where IdTipoBienesServicio = 2
update Empresa.TipoBienesServicio set Codigo = '03' where IdTipoBienesServicio = 3
update Empresa.TipoBienesServicio set Codigo = '04' where IdTipoBienesServicio = 4
update Empresa.TipoBienesServicio set Codigo = '05' where IdTipoBienesServicio = 5
update Empresa.TipoBienesServicio set Codigo = '06' where IdTipoBienesServicio = 6
update Empresa.TipoBienesServicio set Codigo = '07' where IdTipoBienesServicio = 7
update Empresa.TipoBienesServicio set Codigo = '08' where IdTipoBienesServicio = 8
update Empresa.TipoBienesServicio set Codigo = '09' where IdTipoBienesServicio = 9
update Empresa.TipoBienesServicio set Codigo = '10' where IdTipoBienesServicio = 10
update Empresa.TipoBienesServicio set Codigo = '11' where IdTipoBienesServicio = 11



----------------------------------------------------------------------------------------------------------------------------------------------
ALTER TABLE Empresa.TipoRetencionISR ADD CodigoTipoRetencionISR VARCHAR(2)

INSERT INTO Empresa.TipoRetencionISR (IdTipoRetencionISR,Descripcion,Estatus,CodigoTipoRetencionISR) values (9,'N/A',1,'00')

UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '01' WHERE IdTipoRetencionISR=1
UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '02' WHERE IdTipoRetencionISR=2
UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '03' WHERE IdTipoRetencionISR=3
UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '04' WHERE IdTipoRetencionISR=4
UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '05' WHERE IdTipoRetencionISR=5
UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '06' WHERE IdTipoRetencionISR=6
UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '07' WHERE IdTipoRetencionISR=7
UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '08' WHERE IdTipoRetencionISR=8
UPDATE Empresa.TipoRetencionISR SET CodigoTipoRetencionISR = '00' WHERE IdTipoRetencionISR=9




-------------------------------------------------------------------------------------------------------------------------------------------------

select * from Servicio.TipoPago

ALTER TABLE Servicio.TipoPago ADD CodigoTipoPago varchar(2)

UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '01' WHERE IdTipoPago =1
UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '02' WHERE IdTipoPago =2
UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '03' WHERE IdTipoPago =3
UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '04' WHERE IdTipoPago =4
UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '05' WHERE IdTipoPago =5
UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '06' WHERE IdTipoPago =6
UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '07' WHERE IdTipoPago =7
UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '08' WHERE IdTipoPago =8
UPDATE [Servicio].[TipoPago] SET CodigoTipoPago = '09' WHERE IdTipoPago =9


----------------------------------------------------------------------------------------------------------------------------------------------------

USE [DSMarket]
GO
/****** Object:  StoredProcedure [Servicio].[SP_BUSCA_TIPO_PAGO]    Script Date: 8/13/2020 6:17:22 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [Servicio].[SP_BUSCA_TIPO_PAGO]
  @IdTipoPago DECIMAL(20,0) = NULL
, @Descripcion VARCHAR(100) = NULL
, @NumeroPagina INT =1
, @NumeroRegistros INT = 10
AS

SELECT
  TP.IdTipoPago
, UPPER(TP.Descripcion) AS TipoPago
, TP.Estatus AS Estatus0
, CASE TP.Estatus WHEN 1 THEN 'SI' ELSE 'NO' END AS Estatus
, TP.UsuarioAdiciona
, UPPER(UC.Persona) AS CreadPor
, TP.FechaAdiciona
, FORMAT(TP.FechaAdiciona,'dd/MM/yyyy') AS FechaCreado
, UPPER(UM.Persona) AS ModificadoPor
, TP.FechaModifica
, FORMAT(TP.FechaModifica,'dd/MM/yyyy') AS FechaModificado
, TP.BloqueaMonto AS BloqueaMonto0
, CASE TP.BloqueaMonto WHEN 1 THEN 'SI' ELSE 'NO' END AS BloqueaMonto
, TP.ImpuestoAdicional AS ImpuestoAdicional0
, CASE TP.ImpuestoAdicional WHEN 1 THEN 'SI' ELSE 'NO' END AS ImpuestoAdicional
, TP.PorcentajeEntero AS PorcentajeEntero0
, CASE TP.PorcentajeEntero WHEN 1 THEN 'SI' ELSE 'NO' END AS PorcentajeEntero
, TP.Valor
, TP.CodigoTipoPago
, (SELECT
COUNT(*)
FROM [Servicio].[TipoPago] TP
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = TP.UsuarioAdiciona
LEFT JOIN [Seguridad].[Usuario] UM ON UM.IdUsuario = TP.UsuarioModifica
WHERE TP.IdTipoPago = ISNULL(@IdTipoPago,TP.IdTipoPago)
AND TP.Descripcion LIKE '%' + ISNULL(@Descripcion,TP.Descripcion) + '%') AS CantidadRegistros
FROM [Servicio].[TipoPago] TP
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = TP.UsuarioAdiciona
LEFT JOIN [Seguridad].[Usuario] UM ON UM.IdUsuario = TP.UsuarioModifica

WHERE TP.IdTipoPago = ISNULL(@IdTipoPago,TP.IdTipoPago)
AND TP.Descripcion LIKE '%' + ISNULL(@Descripcion,TP.Descripcion) + '%'

ORDER BY TP.IdTipoPago ASC
OFFSET(@NumeroPagina -1) * @NumeroRegistros ROWS
FETCH NEXT @NumeroRegistros ROWS ONLY;



-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


USE [DSMarket]
GO
/****** Object:  StoredProcedure [Servicio].[SP_MANTENIMIENTO_TIPO_PAGO]    Script Date: 8/13/2020 6:18:10 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [Servicio].[SP_MANTENIMIENTO_TIPO_PAGO]
  @IdTipoPago DECIMAL(20,0)
, @Descripcion VARCHAR(100)
, @Estatus BIT
, @UsuarioAdiciona DECIMAL(20,0)
, @BloqueaMonto BIT
, @ImpuestoAdicional BIT
, @PorcentajeEntero BIT
, @Valor DECIMAL(20,2)
, @CodigoTipoPago VARCHAR(2)
, @Accion VARCHAR(150) = 'INSERT'

AS

DECLARE @ITEMS TABLE
(
  IdTipoPago DECIMAL(20,0)
, Descripcion VARCHAR(100)
, Estatus BIT
, UsuarioAdiciona DECIMAL(20,0)
, FechaAdiciona DATE
, UsuarioModifica DECIMAL(20,0)
, FechaModifica DATE
, BloqueaMonto BIT
, ImpuestoAdicional BIT
, PorcentajeEntero BIT
, Valor DECIMAL(20,2)
, CodigoTipoPago VARCHAR(2)
)

IF(@Accion='INSERT')
	
	BEGIN
		
		SELECT
		@IdTipoPago = ISNULL(MAX(IdTipoPago),0) + 1
		FROM [Servicio].[TipoPago] 
		IF(ISNULL(@IdTipoPago,0) = 0)
		SET @IdTipoPago = 1
			
			INSERT INTO [Servicio].[TipoPago]
			(
				  IdTipoPago
                , Descripcion
                , Estatus
                , UsuarioAdiciona
                , FechaAdiciona
                , UsuarioModifica
                , FechaModifica
                , BloqueaMonto
				, ImpuestoAdicional
				, PorcentajeEntero
				, Valor
				, CodigoTipoPago
			)
				
				OUTPUT
					
					  inserted.IdTipoPago
					, inserted.Descripcion
					, inserted.Estatus
					, inserted.UsuarioAdiciona
					, inserted.FechaAdiciona
					, inserted.UsuarioModifica
					, inserted.FechaModifica
					, inserted.BloqueaMonto
					, inserted.ImpuestoAdicional
					, inserted.PorcentajeEntero
					, inserted.Valor
					, inserted.CodigoTipoPago
						
						INTO @ITEMS
							
							VALUES
							(
								  @IdTipoPago
								, @Descripcion
								, @Estatus
								, @UsuarioAdiciona
								, GETDATE()
								, @UsuarioAdiciona
								, GETDATE()
								, @BloqueaMonto
								, @ImpuestoAdicional
								, @PorcentajeEntero
								, @Valor
								, @CodigoTipoPago
							)
END

IF(@Accion = 'UPDATE')
	
	BEGIN
		
		UPDATE [Servicio].[TipoPago] SET
			
			  Descripcion=@Descripcion
			, Estatus=@Estatus
			, UsuarioModifica=@UsuarioAdiciona
			, FechaModifica=GETDATE()
			, BloqueaMonto=@BloqueaMonto
			, ImpuestoAdicional = @ImpuestoAdicional
			, PorcentajeEntero = @PorcentajeEntero
			, Valor = @Valor
			, CodigoTipoPago = @CodigoTipoPago
				
				OUTPUT
					
					  inserted.IdTipoPago
					, inserted.Descripcion
					, inserted.Estatus
					, inserted.UsuarioAdiciona
					, inserted.FechaAdiciona
					, inserted.UsuarioModifica
					, inserted.FechaModifica
					, inserted.BloqueaMonto
					, inserted.ImpuestoAdicional
					, inserted.PorcentajeEntero
					, inserted.Valor
					, inserted.CodigoTipoPago
						
						INTO @ITEMS
							
							WHERE IdTipoPago = @IdTipoPago
END
SELECT * FROM @ITEMS



----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


USE [DSMarket]
GO
/****** Object:  StoredProcedure [Empresa].[SP_BUSCA_REGISTROS_COMPRA_SUPLIDORES]    Script Date: 8/13/2020 9:25:32 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [Empresa].[SP_BUSCA_REGISTROS_COMPRA_SUPLIDORES]
  @IdCompraSuplidor DECIMAL(20,0) = NULL
, @IdTipoSuplidor DECIMAL(20,0) = NULL
, @IdSuplidor DECIMAL(20,0) = NULL
, @RNCCedula VARCHAR(100) = NULL
, @FechaCreadoDesde DATE = NULL
, @FechaCreadoHasta DATE = NULL
, @NumeroPagina INT = 1
, @NumeroRegistros INT = 10

AS

SELECT
  CS.IdCompraSuplidor
, CS.IdTipoSuplidor
, UPPER(TS.Descripcion) AS TipoSuplidor
, CS.IdSuplidor
, UPPER(S.Nombre) AS Suplidor
, CS.RNCCedula
, CS.IdTipoIdentificacion
, UPPER(TI.Descripcion) AS TipoIdentificacion
, CS.IdTipoBienesServicios
, UPPER(TBS.Descripcion) AS TipoBienesServicios
, TBS.Codigo AS CodigoTipoBienesServicio
, CS.NCF
, CS.NCFModificado
, CS.FechaComprobante AS FechaComprobante0
, CONCAT(CAST(DATEPART(YEAR,CS.FechaComprobante) AS VARCHAR),CAST(DATEPART(MONTH,CS.FechaComprobante) AS VARCHAR),CAST(DATEPART(DAY,CS.FechaComprobante) AS VARCHAR)) AS FechaComprobante 
, CS.FechaPago AS FechaPago0
, CONCAT(CAST(DATEPART(YEAR,CS.FechaPago) AS VARCHAR),CAST(DATEPART(MONTH,CS.FechaPago) AS VARCHAR),CAST(DATEPART(DAY,CS.FechaPago) AS VARCHAR)) AS FechaPago 
, CS.MontoFacturadoServicios
, CS.MontoFacturadoBienes
, CS.TotalMontoFacturado
, CS.ITBISFacturado
, CS.ITBISRetenido
, CS.ITBISSujetoProporcionalidad
, CS.ITBISLlevadoCosto
, CS.ITBISPorAdelantar
, CS.ITBISPercibidoCompras
, CS.IdTipoRetencionISR
, UPPER(TISR.Descripcion) AS TipoRetencionISR
, TISR.CodigoTipoRetencionISR
, CS.MontoRetencionRenta
, CS.ISRPercibidoCompras
, CS.ImpuestoSelectivoConsumo
, CS.OtrosImpuestosTasa
, CS.MontoPropinaLegal
, CS.IdFormaPago
, UPPER(TP.Descripcion) AS FormaPago
, TP.CodigoTipoPago
, CS.UsuarioAdiciona
, UPPER(UC.Persona) AS CreadoPor
, CS.FechaCreado AS FechaCreado0
, FORMAT(CS.FechaCreado,'dd/MM/yyyy') AS FechaCreado
, (SELECT
COUNT(*)
FROM [Empresa].[CompraSuplidores] CS
INNER JOIN [Inventario].[TipoSuplidor] TS ON TS.IdTipoSuplidor = CS.IdTipoSuplidor
INNER JOIN [Inventario].[suplidor] S ON S.IdSuplidor = CS.IdSuplidor
INNER JOIN [Empresa].[TipoIdentificacion] TI ON TI.IdTipoIdentificacion = CS.IdTipoIdentificacion
INNER JOIN [Empresa].[TipoBienesServicio] TBS ON TBS.IdTipoBienesServicio = CS.IdTipoBienesServicios
INNER JOIN [Empresa].[TipoRetencionISR] TISR ON TISR.IdTipoRetencionISR = CS.IdTipoRetencionISR
INNER JOIN [Servicio].[TipoPago] TP ON TP.IdTipoPago = CS.IdFormaPago
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = CS.UsuarioAdiciona
WHERE CS.IdCompraSuplidor = ISNULL(@IdCompraSuplidor,CS.IdCompraSuplidor)
AND CS.IdTipoSuplidor = ISNULL(@IdTipoSuplidor,CS.IdTipoSuplidor)
AND CS.IdSuplidor = ISNULL(@IdSuplidor,CS.IdSuplidor)
AND CS.RNCCedula = ISNULL(@RNCCedula,CS.RNCCedula)
AND (
CS.FechaCreado >= ISNULL(@FechaCreadoDesde,CS.FechaCreado)
AND CS.FechaCreado <= ISNULL(@FechaCreadoHasta,CS.FechaCreado)
)) AS CantidadRegistros
FROM [Empresa].[CompraSuplidores] CS
INNER JOIN [Inventario].[TipoSuplidor] TS ON TS.IdTipoSuplidor = CS.IdTipoSuplidor
INNER JOIN [Inventario].[suplidor] S ON S.IdSuplidor = CS.IdSuplidor
INNER JOIN [Empresa].[TipoIdentificacion] TI ON TI.IdTipoIdentificacion = CS.IdTipoIdentificacion
INNER JOIN [Empresa].[TipoBienesServicio] TBS ON TBS.IdTipoBienesServicio = CS.IdTipoBienesServicios
INNER JOIN [Empresa].[TipoRetencionISR] TISR ON TISR.IdTipoRetencionISR = CS.IdTipoRetencionISR
INNER JOIN [Servicio].[TipoPago] TP ON TP.IdTipoPago = CS.IdFormaPago
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = CS.UsuarioAdiciona

WHERE CS.IdCompraSuplidor = ISNULL(@IdCompraSuplidor,CS.IdCompraSuplidor)
AND CS.IdTipoSuplidor = ISNULL(@IdTipoSuplidor,CS.IdTipoSuplidor)
AND CS.IdSuplidor = ISNULL(@IdSuplidor,CS.IdSuplidor)
AND CS.RNCCedula = ISNULL(@RNCCedula,CS.RNCCedula)
AND (
CS.FechaCreado >= ISNULL(@FechaCreadoDesde,CS.FechaCreado)
AND CS.FechaCreado <= ISNULL(@FechaCreadoHasta,CS.FechaCreado)
)

ORDER BY CS.IdCompraSuplidor ASC
OFFSET(@NumeroPagina  -1) * @NumeroRegistros ROWS
FETCH NEXT @NumeroRegistros ROWS ONLY;



--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

create table Configuracion.RutaArchivostxt
(
IdRutaArchivotxt int,
Ruta varchar(8000))


insert into Configuracion.RutaArchivostxt (IdRutaArchivotxt,Ruta) values (1,'')

CREATE PROCEDURE [Configuracion].[SP_BUSCAR_RUTA_ARCHIVO_TXT]
@IdRutaArchivostxt INT =1

AS

SELECT
  R.IdRutaArchivotxt
, R.Ruta
FROM [Configuracion].[RutaArchivostxt] R

WHERE R.IdRutaArchivotxt = ISNULL(@IdRutaArchivostxt,R.IdRutaArchivotxt)


CREATE PROCEDURE [Configuracion].[SP_MODIFICAR_RUTA_ARCHIVO_TXT]  
  @IdRutaArchivotxt INT
, @Ruta VARCHAR(8000)
, @Accion VARCHAR(150) = 'INSERT'

AS

DECLARE @ITEMS TABLE
(
  IdRutaArchivotxt INT
, Ruta VARCHAR(8000)
)

IF(@Accion='UPDATE')
	
	BEGIN
		
		UPDATE [Configuracion].[RutaArchivostxt] SET
			
			Ruta = @Ruta
				
				OUTPUT
					
					  inserted.IdRutaArchivotxt
					, inserted.Ruta

						INTO @ITEMS
							
							WHERE IdRutaArchivotxt = @IdRutaArchivotxt
END
SELECT * FROM @ITEMS


-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
create table Reporte.Reporte606
(
IdUsuario DECIMAL(20,0),
IdCompraSuplidor DECIMAL(20,0),
IdTipoSuplidor DECIMAL(20,0)
TipoSuplidor VARCHAR(100),
IdSuplidor DECIMAL(20,0),
Suplidor VARCHAR(100),
RNCCedula VARCHAR(100),
IdTipoIdentificacion DECIMAL(20,0),
TipoIdentificacion VARCHAR(100),
IdTipoBienesServicios DECIMAL(20,0),
TipoBienesServicios VARCHAR(100),
CodigoTipoBienesServicio VARCHAR(2),
NCF VARCHAR(100),
NCFMODIFICADO VARCHAR(100),
FechaComprobante0 DATE,
FechaComprobante VARCHAR(100),
FechaPago0 DATE,
FechaPago VARCHAR(100),
MontoFacturadoServicios DECIMAL(20,2),
MontoFacturadoBienes DECIMAL(20,2),
TotalMontoFacturado DECIMAL(20,2),
ITBISFacturado DECIMAL(20,2),
ITBISRetenido DECIMAL(20,2),
ITBISSujetoProporcionalidad DECIMAL(20,2),
ITBISLlevadoCosto DECIMAL(20,2),
ITBISPorAdelantar DECIMAL(20,2),
ITBISPercibidoCompras DECIMAL(20,2),
IdTipoRetencionISR DECIMAL(20,0),
TipoRetencionISR VARCHAR(100),
CodigoTipoRetencionISR VARCHAR(2),
MontoRetencionRenta DECIMAL(20,2),
ISRPercibidoCompras DECIMAL(20,2),
ImpuestoSelectivoConsumo DECIMAL(20,2),
OtrosImpuestosTasa DECIMAL(20,2),
MontoPropinaLegal DECIMAL(20,2),
IdFormaPago DECIMAL(20,0),
FormaPago VARCHAR(100),
CodigoTipoPago VARCHAR(2),
UsuarioAdiciona DECIMAL(20,0),
CreadoPor VARCHAR(100),
FechaCreado0 DATE,
FechaCreado VARCHAR(100),
CantidadRegistros DECIMAL(20,0),
ValidadoDesde DATE,
ValidadoHasta DATE
)

CREATE PROCEDURE [Reporte].[SP_GUARDAR_DATOS_REPORTE_606]
  @IdUsuario DECIMAL(20,0)
, @IdCompraSuplidor DECIMAL(20,0)
, @IdTipoSuplidor DECIMAL(20,0)
, @TipoSuplidor VARCHAR(100)
, @IdSuplidor DECIMAL(20,0)
, @Suplidor VARCHAR(100)
, @RNCCedula VARCHAR(100)
, @IdTipoIdentificacion DECIMAL(20,0)
, @TipoIdentificacion VARCHAR(100)
, @IdTipoBienesServicios DECIMAL(20,0)
, @TipoBienesServicios VARCHAR(100)
, @CodigoTipoBienesServicio VARCHAR(2)
, @NCF VARCHAR(100)
, @NCFMODIFICADO VARCHAR(100)
, @FechaComprobante0 DATE
, @FechaComprobante VARCHAR(100)
, @FechaPago0 DATE
, @FechaPago VARCHAR(100)
, @MontoFacturadoServicios DECIMAL(20,2)
, @MontoFacturadoBienes DECIMAL(20,2)
, @TotalMontoFacturado DECIMAL(20,2)
, @ITBISFacturado DECIMAL(20,2)
, @ITBISRetenido DECIMAL(20,2)
, @ITBISSujetoProporcionalidad DECIMAL(20,2)
, @ITBISLlevadoCosto DECIMAL(20,2)
, @ITBISPorAdelantar DECIMAL(20,2)
, @ITBISPercibidoCompras DECIMAL(20,2)
, @IdTipoRetencionISR DECIMAL(20,0)
, @TipoRetencionISR VARCHAR(100)
, @CodigoTipoRetencionISR VARCHAR(2)
, @MontoRetencionRenta DECIMAL(20,2)
, @ISRPercibidoCompras DECIMAL(20,2)
, @ImpuestoSelectivoConsumo DECIMAL(20,2)
, @OtrosImpuestosTasa DECIMAL(20,2)
, @MontoPropinaLegal DECIMAL(20,2)
, @IdFormaPago DECIMAL(20,0)
, @FormaPago VARCHAR(100)
, @CodigoTipoPago VARCHAR(2)
, @UsuarioAdiciona DECIMAL(20,0)
, @CreadoPor VARCHAR(100)
, @FechaCreado0 DATE
, @FechaCreado VARCHAR(100)
, @CantidadRegistros DECIMAL(20,0)
, @ValidadoDesde DATE
, @ValidadoHasta DATE
, @Accion VARCHAR(150) = 'INSERT'


AS


DECLARE @ITEMS TABLE
(
  IdUsuario DECIMAL(20,0)
, IdCompraSuplidor DECIMAL(20,0)
, IdTipoSuplidor DECIMAL(20,0)
, TipoSuplidor VARCHAR(100)
, IdSuplidor DECIMAL(20,0)
, Suplidor VARCHAR(100)
, RNCCedula VARCHAR(100)
, IdTipoIdentificacion DECIMAL(20,0)
, TipoIdentificacion VARCHAR(100)
, IdTipoBienesServicios DECIMAL(20,0)
, TipoBienesServicios VARCHAR(100)
, CodigoTipoBienesServicio VARCHAR(2)
, NCF VARCHAR(100)
, NCFMODIFICADO VARCHAR(100)
, FechaComprobante0 DATE
, FechaComprobante VARCHAR(100)
, FechaPago0 DATE
, FechaPago VARCHAR(100)
, MontoFacturadoServicios DECIMAL(20,2)
, MontoFacturadoBienes DECIMAL(20,2)
, TotalMontoFacturado DECIMAL(20,2)
, ITBISFacturado DECIMAL(20,2)
, ITBISRetenido DECIMAL(20,2)
, ITBISSujetoProporcionalidad DECIMAL(20,2)
, ITBISLlevadoCosto DECIMAL(20,2)
, ITBISPorAdelantar DECIMAL(20,2)
, ITBISPercibidoCompras DECIMAL(20,2)
, IdTipoRetencionISR DECIMAL(20,0)
, TipoRetencionISR VARCHAR(100)
, CodigoTipoRetencionISR VARCHAR(2)
, MontoRetencionRenta DECIMAL(20,2)
, ISRPercibidoCompras DECIMAL(20,2)
, ImpuestoSelectivoConsumo DECIMAL(20,2)
, OtrosImpuestosTasa DECIMAL(20,2)
, MontoPropinaLegal DECIMAL(20,2)
, IdFormaPago DECIMAL(20,0)
, FormaPago VARCHAR(100)
, CodigoTipoPago VARCHAR(2)
, UsuarioAdiciona DECIMAL(20,0)
, CreadoPor VARCHAR(100)
, FechaCreado0 DATE
, FechaCreado VARCHAR(100)
, CantidadRegistros DECIMAL(20,0)
, ValidadoDesde DATE
, ValidadoHasta DATE
)

IF(@Accion='INSERT')
	
	BEGIN
		
		INSERT INTO [Reporte].[Reporte606]
    	(
    		IdUsuario
          , IdCompraSuplidor
		  , IdTipoSuplidor
          , TipoSuplidor
          , IdSuplidor
          , Suplidor
          , RNCCedula
          , IdTipoIdentificacion
          , TipoIdentificacion
          , IdTipoBienesServicios
          , TipoBienesServicios
          , CodigoTipoBienesServicio
          , NCF
          , NCFMODIFICADO
          , FechaComprobante0
          , FechaComprobante
          , FechaPago0
          , FechaPago
          , MontoFacturadoServicios
          , MontoFacturadoBienes
          , TotalMontoFacturado
          , ITBISFacturado
          , ITBISRetenido
          , ITBISSujetoProporcionalidad
          , ITBISLlevadoCosto
          , ITBISPorAdelantar
          , ITBISPercibidoCompras
          , IdTipoRetencionISR
          , TipoRetencionISR
          , CodigoTipoRetencionISR
          , MontoRetencionRenta
          , ISRPercibidoCompras
          , ImpuestoSelectivoConsumo
          , OtrosImpuestosTasa
          , MontoPropinaLegal
          , IdFormaPago
          , FormaPago
          , CodigoTipoPago
          , UsuarioAdiciona
          , CreadoPor
          , FechaCreado0
          , FechaCreado
          , CantidadRegistros
		  , ValidadoDesde
		  , ValidadoHasta
    )
		
		OUTPUT
			
		      inserted.IdUsuario
            , inserted.IdCompraSuplidor
			, inserted.IdTipoSuplidor
            , inserted.TipoSuplidor
            , inserted.IdSuplidor
            , inserted.Suplidor
            , inserted.RNCCedula
            , inserted.IdTipoIdentificacion
            , inserted.TipoIdentificacion
            , inserted.IdTipoBienesServicios
            , inserted.TipoBienesServicios
            , inserted.CodigoTipoBienesServicio
            , inserted.NCF
            , inserted.NCFMODIFICADO
            , inserted.FechaComprobante0
            , inserted.FechaComprobante
            , inserted.FechaPago0
            , inserted.FechaPago
            , inserted.MontoFacturadoServicios
            , inserted.MontoFacturadoBienes
            , inserted.TotalMontoFacturado
            , inserted.ITBISFacturado
            , inserted.ITBISRetenido
            , inserted.ITBISSujetoProporcionalidad
            , inserted.ITBISLlevadoCosto
            , inserted.ITBISPorAdelantar
            , inserted.ITBISPercibidoCompras
            , inserted.IdTipoRetencionISR
            , inserted.TipoRetencionISR
            , inserted.CodigoTipoRetencionISR
            , inserted.MontoRetencionRenta
            , inserted.ISRPercibidoCompras
            , inserted.ImpuestoSelectivoConsumo
            , inserted.OtrosImpuestosTasa
            , inserted.MontoPropinaLegal
            , inserted.IdFormaPago
            , inserted.FormaPago
            , inserted.CodigoTipoPago
            , inserted.UsuarioAdiciona
            , inserted.CreadoPor
            , inserted.FechaCreado0
            , inserted.FechaCreado
            , inserted.CantidadRegistros
			, inserted.ValidadoDesde
			, inserted.ValidadoHasta
				
			 INTO @ITEMS
				
				VALUES
				(
					  @IdUsuario
                    , @IdCompraSuplidor
					, @IdTipoSuplidor
                    , @TipoSuplidor
                    , @IdSuplidor
                    , @Suplidor
                    , @RNCCedula
                    , @IdTipoIdentificacion
                    , @TipoIdentificacion
                    , @IdTipoBienesServicios
                    , @TipoBienesServicios
                    , @CodigoTipoBienesServicio
                    , @NCF
                    , @NCFMODIFICADO
                    , @FechaComprobante0
                    , @FechaComprobante
                    , @FechaPago0
                    , @FechaPago
                    , @MontoFacturadoServicios
                    , @MontoFacturadoBienes
                    , @TotalMontoFacturado
                    , @ITBISFacturado
                    , @ITBISRetenido
                    , @ITBISSujetoProporcionalidad
                    , @ITBISLlevadoCosto
                    , @ITBISPorAdelantar
                    , @ITBISPercibidoCompras
                    , @IdTipoRetencionISR
                    , @TipoRetencionISR
                    , @CodigoTipoRetencionISR
                    , @MontoRetencionRenta
                    , @ISRPercibidoCompras
                    , @ImpuestoSelectivoConsumo
                    , @OtrosImpuestosTasa
                    , @MontoPropinaLegal
                    , @IdFormaPago
                    , @FormaPago
                    , @CodigoTipoPago
                    , @UsuarioAdiciona
                    , @CreadoPor
                    , @FechaCreado0
                    , @FechaCreado
                    , @CantidadRegistros
					, @ValidadoDesde
					, @ValidadoHasta
			 )
END

IF(@Accion='DELETE')
	
	BEGIN
		
		DELETE FROM [Reporte].[Reporte606]
			
			OUTPUT
			
		      deleted.IdUsuario
            , deleted.IdCompraSuplidor
			, deleted.IdTipoSuplidor
            , deleted.TipoSuplidor
            , deleted.IdSuplidor
            , deleted.Suplidor
            , deleted.RNCCedula
            , deleted.IdTipoIdentificacion
            , deleted.TipoIdentificacion
            , deleted.IdTipoBienesServicios
            , deleted.TipoBienesServicios
            , deleted.CodigoTipoBienesServicio
            , deleted.NCF
            , deleted.NCFMODIFICADO
            , deleted.FechaComprobante0
            , deleted.FechaComprobante
            , deleted.FechaPago0
            , deleted.FechaPago
            , deleted.MontoFacturadoServicios
            , deleted.MontoFacturadoBienes
            , deleted.TotalMontoFacturado
            , deleted.ITBISFacturado
            , deleted.ITBISRetenido
            , deleted.ITBISSujetoProporcionalidad
            , deleted.ITBISLlevadoCosto
            , deleted.ITBISPorAdelantar
            , deleted.ITBISPercibidoCompras
            , deleted.IdTipoRetencionISR
            , deleted.TipoRetencionISR
            , deleted.CodigoTipoRetencionISR
            , deleted.MontoRetencionRenta
            , deleted.ISRPercibidoCompras
            , deleted.ImpuestoSelectivoConsumo
            , deleted.OtrosImpuestosTasa
            , deleted.MontoPropinaLegal
            , deleted.IdFormaPago
            , deleted.FormaPago
            , deleted.CodigoTipoPago
            , deleted.UsuarioAdiciona
            , deleted.CreadoPor
            , deleted.FechaCreado0
            , deleted.FechaCreado
            , deleted.CantidadRegistros
			, deleted.ValidadoDesde
			, deleted.ValidadoHasta
				
			 INTO @ITEMS
				
				WHERE IdUsuario = @IdUsuario
END
SELECT * FROM @ITEMS

CREATE PROCEDURE [Reporte].[SP_GENERAR_REPORTE_606]
@IdUsuario DECIMAL(20,0) = 1

AS

SELECT
  R.IdUsuario
, UPPER(UG.Persona) AS GeneradoPor
, R.IdCompraSuplidor
, R.IdTipoSuplidor
, R.TipoSuplidor
, R.IdSuplidor
, R.Suplidor
, R.RNCCedula
, R.IdTipoIdentificacion
, R.TipoIdentificacion
, R.IdTipoBienesServicios
, R.TipoBienesServicios
, R.CodigoTipoBienesServicio
, R.NCF
, R.NCFMODIFICADO
, R.FechaComprobante0
, R.FechaComprobante
, R.FechaPago0
, R.FechaPago
, R.MontoFacturadoServicios
, R.MontoFacturadoBienes
, R.TotalMontoFacturado
, R.ITBISFacturado
, R.ITBISRetenido
, R.ITBISSujetoProporcionalidad
, R.ITBISLlevadoCosto
, R.ITBISPorAdelantar
, R.ITBISPercibidoCompras
, R.IdTipoRetencionISR
, R.TipoRetencionISR
, R.CodigoTipoRetencionISR
, R.MontoRetencionRenta
, R.ISRPercibidoCompras
, R.ImpuestoSelectivoConsumo
, R.OtrosImpuestosTasa
, R.MontoPropinaLegal
, R.IdFormaPago
, R.FormaPago
, R.CodigoTipoPago
, R.UsuarioAdiciona
, R.CreadoPor
, R.FechaCreado0
, R.FechaCreado
, R.CantidadRegistros
, R.ValidadoDesde AS ValidadoDesde0
, R.ValidadoHasta AS ValidadoHasta0
, FORMAT(R.ValidadoDesde,'dd/MM/yyyy') AS ValidadoDesde
, FORMAT(R.ValidadoHasta,'dd/MM/yyyy') AS ValidadoHasta
, I.NombreEmpresa
, I.RNC
, I.Direccion
, I.Telefonos
, I.Email
, I.Email2
, I.Instagran
, I.Facebook
, IMG.LogoEmpresa
FROM [Reporte].[Reporte606] R
INNER JOIN [Configuracion].[InformacionEmpresa] I ON I.IdInformacionEmpresa =1
INNER JOIN [Configuracion].[ImagenesSistema] IMG ON IMG.IdLogoEmpresa = 1
LEFT JOIN [Seguridad].[Usuario] UG ON UG.IdUsuario = R.IdUsuario
WHERE R.IdUsuario = ISNULL(@IdUsuario,R.IdUsuario)

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
USE [DSMarket]
GO
/****** Object:  StoredProcedure [Inventario].[SP_BUSCA_PRODUCTO]    Script Date: 8/15/2020 9:47:13 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [Inventario].[SP_BUSCA_PRODUCTO] 
  @IdProducto DECIMAL(20,0) = NULL
, @NumeroConector DECIMAL(20,0) = NULL
, @Descripcion VARCHAR(200) = NULL
, @CodigoBarra VARCHAR(100) = NULL
, @Referencia VARCHAR(100) = NULL
, @FechaDesde DATE = NULL
, @FechaHasta DATE = NULL
, @IdTipoProducto DECIMAL(20,0) = NULL
, @IdCategoria DECIMAL(20,0) = NULL
, @IdUnidadMedida DECIMAL(20,0) = NULL
, @IdMarca DECIMAL(20,0) = NULL
, @IdModelo DECIMAL(20,0) = NULL
, @TieneOferta BIT = NULL
, @EstatusProducto BIT = NULL
, @NumeroSeguimiento VARCHAR(100)
, @NumeroPagina INT = 1
, @NumeroRegistros INT = 10

AS

SELECT
  PRO.IdProducto
, PRO.NumeroConector
, PRO.IdTipoProducto
, UPPER(PRO.Descripcion) AS Producto
, UPPER(TPRO.Descripcion) AS TipoProducto
, PRO.IdCategoria
, UPPER(CA.Descripcion) AS Categoria
, PRO.IdUnidadMedida
, UPPER(U.Descripcion) AS UnidadMedida
, PRO.IdMarca
, UPPER(MA.Descripcion) AS Marca
, PRO.IdModelo
, UPPER(MO.Descripcion) AS Modelo
, PRO.IdTipoSuplidor
, UPPER(TS.Descripcion) AS TipoSuplidor
, PRO.IdSuplidor
, UPPER(S.Nombre) AS Suplidor
, PRO.CodigoBarra
, PRO.Referencia
, PRO.PrecioCompra
, PRO.PrecioVenta
, PRO.Stock
, PRO.StockMinimo
, PRO.PorcientoDescuento
, PRO.AfectaOferta AS AfectaOferta0
, CASE PRO.AfectaOferta WHEN 1 THEN 'SI' ELSE 'NO' END AS AceptaOferta
, PRO.ProductoAcumulativo AS ProductoAcumulativo0
, CASE PRO.ProductoAcumulativo WHEN 1 THEN 'SI' ELSE 'NO' END AS ProductoAcumulativo
, PRO.LlevaImagen AS LlevaImagen0
, CASE PRO.LlevaImagen WHEN 1 THEN 'SI' ELSE 'NO' END LlevaImagen
, PRO.UsuarioAdicion
, UPPER(UC.Persona) AS CreadoPor
, PRO.FechaAdiciona
, FORMAT(PRO.FechaAdiciona,'dd/MM/yyyy') AS FechaCreado
, PRO.UsuarioModifica
, UPPER(UM.Persona) AS ModificadoPor
, PRO.FechaModifica
, FORMAT(PRO.FechaModifica,'dd/MM/yyyy') AS FechaModificado
, PRO.Fecha
, PRO.AplicaParaImpuesto AS AplicaParaImpuesto0
, PRO.EstatusProducto AS EstatusProducto0
, CASE PRO.EstatusProducto WHEN 1 THEN 'VENDIDO'ELSE'EN INVENTARIO' END AS EstatusProducto
, CASE PRO.AplicaParaImpuesto WHEN 1 THEN 'SI' ELSE 'NO' END AS AplicaParaImpuesto
, PRO.NumeroSeguimiento
, COALESCE((SELECT
COUNT(*)
FROM [Inventario].[Producto] PRO
INNER JOIN [Inventario].[TipoProducto] TPRO ON TPRO.IdTipoproducto = PRO.IdTipoProducto
INNER JOIN [Inventario].[Categoria] CA ON CA.IdCategoria = PRO.IdCategoria
INNER JOIN [Inventario].[UnidadMedida] U ON U.IdUnidadMedida = PRO.IdUnidadMedida
INNER JOIN [Inventario].[Marcas] MA ON MA.IdMarca = PRO.IdMarca
INNER JOIN [Inventario].[Modelos] MO ON MO.IdModelo = PRO.IdModelo
INNER JOIN [Inventario].[TipoSuplidor] TS ON TS.IdTipoSuplidor = PRO.IdTipoSuplidor
INNER JOIN [Inventario].[suplidor] S ON S.IdSuplidor = PRO.IdSuplidor
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = PRO.UsuarioAdicion
LEFT JOIN [Seguridad].[Usuario] UM ON UM.IdUsuario = PRO.UsuarioModifica
WHERE PRO.IdProducto = ISNULL(@IdProducto,PRO.IdProducto)
AND PRO.NumeroConector = ISNULL(@NumeroConector,PRO.NumeroConector)
AND PRO.Descripcion LIKE '%' + ISNULL(@Descripcion,PRO.Descripcion) + '%'
AND PRO.CodigoBarra LIKE '%' + ISNULL(@CodigoBarra,PRO.CodigoBarra) + '%'
AND PRO.Referencia LIKE '%' + ISNULL(@Referencia,PRO.Referencia) + '%'
AND (
CAST(PRO.Fecha AS DATE) >= ISNULL(@FechaDesde,CAST(PRO.Fecha AS DATE))
AND CAST(PRO.Fecha AS DATE) <= ISNULL(@FechaHasta,CAST(PRO.Fecha AS DATE)))
AND PRO.IdTipoProducto = ISNULL(@IdTipoProducto,PRO.IdTipoProducto)
AND PRO.IdCategoria = ISNULL(@IdCategoria,PRO.IdCategoria)
AND PRO.IdUnidadMedida = ISNULL(@IdUnidadMedida,PRO.IdUnidadMedida)
AND PRO.IdMarca = ISNULL(@IdMarca,PRO.IdMarca)
AND PRO.IdModelo = ISNULL(@IdModelo,PRO.IdModelo)
AND PRO.AfectaOferta = ISNULL(@TieneOferta,PRO.AfectaOferta)
AND PRO.EstatusProducto = ISNULL(@EstatusProducto,PRO.EstatusProducto)
AND PRO.NumeroSeguimiento LIKE '%' + ISNULL(@NumeroSeguimiento,PRO.NumeroSeguimiento) + '%'),0) AS CantidadRegistros



, COALESCE((SELECT
COUNT(*)
FROM [Inventario].[Producto] PRO
INNER JOIN [Inventario].[TipoProducto] TPRO ON TPRO.IdTipoproducto = PRO.IdTipoProducto
INNER JOIN [Inventario].[Categoria] CA ON CA.IdCategoria = PRO.IdCategoria
INNER JOIN [Inventario].[UnidadMedida] U ON U.IdUnidadMedida = PRO.IdUnidadMedida
INNER JOIN [Inventario].[Marcas] MA ON MA.IdMarca = PRO.IdMarca
INNER JOIN [Inventario].[Modelos] MO ON MO.IdModelo = PRO.IdModelo
INNER JOIN [Inventario].[TipoSuplidor] TS ON TS.IdTipoSuplidor = PRO.IdTipoSuplidor
INNER JOIN [Inventario].[suplidor] S ON S.IdSuplidor = PRO.IdSuplidor
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = PRO.UsuarioAdicion
LEFT JOIN [Seguridad].[Usuario] UM ON UM.IdUsuario = PRO.UsuarioModifica
WHERE PRO.IdProducto = ISNULL(@IdProducto,PRO.IdProducto)
AND PRO.NumeroConector = ISNULL(@NumeroConector,PRO.NumeroConector)
AND PRO.Descripcion LIKE '%' + ISNULL(@Descripcion,PRO.Descripcion) + '%'
AND PRO.CodigoBarra LIKE '%' + ISNULL(@CodigoBarra,PRO.CodigoBarra) + '%'
AND PRO.Referencia LIKE '%' + ISNULL(@Referencia,PRO.Referencia) + '%'
AND (
CAST(PRO.Fecha AS DATE) >= ISNULL(@FechaDesde,CAST(PRO.Fecha AS DATE))
AND CAST(PRO.Fecha AS DATE) <= ISNULL(@FechaHasta,CAST(PRO.Fecha AS DATE)))
AND PRO.IdTipoProducto = ISNULL(@IdTipoProducto,PRO.IdTipoProducto)
AND PRO.IdCategoria = ISNULL(@IdCategoria,PRO.IdCategoria)
AND PRO.IdUnidadMedida = ISNULL(@IdUnidadMedida,PRO.IdUnidadMedida)
AND PRO.IdMarca = ISNULL(@IdMarca,PRO.IdMarca)
AND PRO.IdModelo = ISNULL(@IdModelo,PRO.IdModelo)
AND PRO.AfectaOferta = 1
AND PRO.EstatusProducto = ISNULL(@EstatusProducto,PRO.EstatusProducto)
AND PRO.NumeroSeguimiento LIKE '%' + ISNULL(@NumeroSeguimiento,PRO.NumeroSeguimiento) + '%'),0) AS ProductosConOferta





, COALESCE((SELECT
COUNT(*)
FROM [Inventario].[Producto] PRO
INNER JOIN [Inventario].[TipoProducto] TPRO ON TPRO.IdTipoproducto = PRO.IdTipoProducto
INNER JOIN [Inventario].[Categoria] CA ON CA.IdCategoria = PRO.IdCategoria
INNER JOIN [Inventario].[UnidadMedida] U ON U.IdUnidadMedida = PRO.IdUnidadMedida
INNER JOIN [Inventario].[Marcas] MA ON MA.IdMarca = PRO.IdMarca
INNER JOIN [Inventario].[Modelos] MO ON MO.IdModelo = PRO.IdModelo
INNER JOIN [Inventario].[TipoSuplidor] TS ON TS.IdTipoSuplidor = PRO.IdTipoSuplidor
INNER JOIN [Inventario].[suplidor] S ON S.IdSuplidor = PRO.IdSuplidor
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = PRO.UsuarioAdicion
LEFT JOIN [Seguridad].[Usuario] UM ON UM.IdUsuario = PRO.UsuarioModifica
WHERE PRO.IdProducto = ISNULL(@IdProducto,PRO.IdProducto)
AND PRO.NumeroConector = ISNULL(@NumeroConector,PRO.NumeroConector)
AND PRO.Descripcion LIKE '%' + ISNULL(@Descripcion,PRO.Descripcion) + '%'
AND PRO.CodigoBarra LIKE '%' + ISNULL(@CodigoBarra,PRO.CodigoBarra) + '%'
AND PRO.Referencia LIKE '%' + ISNULL(@Referencia,PRO.Referencia) + '%'
AND (
CAST(PRO.Fecha AS DATE) >= ISNULL(@FechaDesde,CAST(PRO.Fecha AS DATE))
AND CAST(PRO.Fecha AS DATE) <= ISNULL(@FechaHasta,CAST(PRO.Fecha AS DATE)))
AND PRO.IdTipoProducto = ISNULL(@IdTipoProducto,PRO.IdTipoProducto)
AND PRO.IdCategoria = ISNULL(@IdCategoria,PRO.IdCategoria)
AND PRO.IdUnidadMedida = ISNULL(@IdUnidadMedida,PRO.IdUnidadMedida)
AND PRO.IdMarca = ISNULL(@IdMarca,PRO.IdMarca)
AND PRO.IdModelo = ISNULL(@IdModelo,PRO.IdModelo)
AND PRO.AfectaOferta = ISNULL(@TieneOferta,PRO.AfectaOferta)
AND PRO.EstatusProducto = ISNULL(@EstatusProducto,PRO.EstatusProducto)
AND PRO.NumeroSeguimiento LIKE '%' + ISNULL(@NumeroSeguimiento,PRO.NumeroSeguimiento) + '%'
AND PRO.Stock <= (SELECT StockMinimo FROM [Inventario].[Producto] WHERE IdProducto = PRO.IdProducto AND NumeroConector = PRO.NumeroConector)
),0) AS ProductoProximoAgotarse



, COALESCE((SELECT
COUNT(*)
FROM [Inventario].[Producto] PRO
INNER JOIN [Inventario].[TipoProducto] TPRO ON TPRO.IdTipoproducto = PRO.IdTipoProducto
INNER JOIN [Inventario].[Categoria] CA ON CA.IdCategoria = PRO.IdCategoria
INNER JOIN [Inventario].[UnidadMedida] U ON U.IdUnidadMedida = PRO.IdUnidadMedida
INNER JOIN [Inventario].[Marcas] MA ON MA.IdMarca = PRO.IdMarca
INNER JOIN [Inventario].[Modelos] MO ON MO.IdModelo = PRO.IdModelo
INNER JOIN [Inventario].[TipoSuplidor] TS ON TS.IdTipoSuplidor = PRO.IdTipoSuplidor
INNER JOIN [Inventario].[suplidor] S ON S.IdSuplidor = PRO.IdSuplidor
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = PRO.UsuarioAdicion
LEFT JOIN [Seguridad].[Usuario] UM ON UM.IdUsuario = PRO.UsuarioModifica
WHERE PRO.IdProducto = ISNULL(@IdProducto,PRO.IdProducto)
AND PRO.NumeroConector = ISNULL(@NumeroConector,PRO.NumeroConector)
AND PRO.Descripcion LIKE '%' + ISNULL(@Descripcion,PRO.Descripcion) + '%'
AND PRO.CodigoBarra LIKE '%' + ISNULL(@CodigoBarra,PRO.CodigoBarra) + '%'
AND PRO.Referencia LIKE '%' + ISNULL(@Referencia,PRO.Referencia) + '%'
AND (
CAST(PRO.Fecha AS DATE) >= ISNULL(@FechaDesde,CAST(PRO.Fecha AS DATE))
AND CAST(PRO.Fecha AS DATE) <= ISNULL(@FechaHasta,CAST(PRO.Fecha AS DATE)))
AND PRO.IdTipoProducto = ISNULL(@IdTipoProducto,PRO.IdTipoProducto)
AND PRO.IdCategoria = ISNULL(@IdCategoria,PRO.IdCategoria)
AND PRO.IdUnidadMedida = ISNULL(@IdUnidadMedida,PRO.IdUnidadMedida)
AND PRO.IdMarca = ISNULL(@IdMarca,PRO.IdMarca)
AND PRO.IdModelo = ISNULL(@IdModelo,PRO.IdModelo)
AND PRO.AfectaOferta = ISNULL(@TieneOferta,PRO.AfectaOferta)
AND PRO.EstatusProducto = ISNULL(@EstatusProducto,PRO.EstatusProducto)
AND PRO.NumeroSeguimiento LIKE '%' + ISNULL(@NumeroSeguimiento,PRO.NumeroSeguimiento) + '%'
AND PRO.Stock <= 0
),0) AS ProductosAgostados

,PRO.Comentario
FROM [Inventario].[Producto] PRO
INNER JOIN [Inventario].[TipoProducto] TPRO ON TPRO.IdTipoproducto = PRO.IdTipoProducto
INNER JOIN [Inventario].[Categoria] CA ON CA.IdCategoria = PRO.IdCategoria
INNER JOIN [Inventario].[UnidadMedida] U ON U.IdUnidadMedida = PRO.IdUnidadMedida
INNER JOIN [Inventario].[Marcas] MA ON MA.IdMarca = PRO.IdMarca
INNER JOIN [Inventario].[Modelos] MO ON MO.IdModelo = PRO.IdModelo
INNER JOIN [Inventario].[TipoSuplidor] TS ON TS.IdTipoSuplidor = PRO.IdTipoSuplidor
INNER JOIN [Inventario].[suplidor] S ON S.IdSuplidor = PRO.IdSuplidor
LEFT JOIN [Seguridad].[Usuario] UC ON UC.IdUsuario = PRO.UsuarioAdicion
LEFT JOIN [Seguridad].[Usuario] UM ON UM.IdUsuario = PRO.UsuarioModifica

WHERE PRO.IdProducto = ISNULL(@IdProducto,PRO.IdProducto)
AND PRO.NumeroConector = ISNULL(@NumeroConector,PRO.NumeroConector)
AND PRO.Descripcion LIKE '%' + ISNULL(@Descripcion,PRO.Descripcion) + '%'
AND PRO.CodigoBarra LIKE '%' + ISNULL(@CodigoBarra,PRO.CodigoBarra) + '%'
AND PRO.Referencia LIKE '%' + ISNULL(@Referencia,PRO.Referencia) + '%'
AND (
CAST(PRO.Fecha AS DATE) >= ISNULL(@FechaDesde,CAST(PRO.Fecha AS DATE))
AND CAST(PRO.Fecha AS DATE) <= ISNULL(@FechaHasta,CAST(PRO.Fecha AS DATE)))
AND PRO.IdTipoProducto = ISNULL(@IdTipoProducto,PRO.IdTipoProducto)
AND PRO.IdCategoria = ISNULL(@IdCategoria,PRO.IdCategoria)
AND PRO.IdUnidadMedida = ISNULL(@IdUnidadMedida,PRO.IdUnidadMedida)
AND PRO.IdMarca = ISNULL(@IdMarca,PRO.IdMarca)
AND PRO.IdModelo = ISNULL(@IdModelo,PRO.IdModelo)
AND PRO.AfectaOferta = ISNULL(@TieneOferta,PRO.AfectaOferta)
AND PRO.EstatusProducto = ISNULL(@EstatusProducto,PRO.EstatusProducto)
AND PRO.NumeroSeguimiento LIKE '%' + ISNULL(@NumeroSeguimiento,PRO.NumeroSeguimiento) + '%'
ORDER BY PRO.IdProducto ASC
OFFSET(@NumeroPagina -1) * @NumeroRegistros ROWS
FETCH NEXT @NumeroRegistros ROWS ONLY;


-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

CREATE PROCEDURE [Configuracion].[SP_MODIFICAR_CONFIGURACION_GENERAL]
  @IdConfiguracionGeneral INT
, @Descripcion VARCHAR(200)
, @Estatus BIT
, @Accion VARCHAR(150) = 'UPDATE'

AS

DECLARE @ITEMS TABLE
(
  IdConfiguracionGeneral INT
, Descripcion VARCHAR(200)
, Estatus BIT
)

IF(@Accion='UPDATE')
	
	BEGIN
		
		UPDATE [Configuracion].[ConfiguracionGeneral] SET
			
			  Descripcion = @Descripcion
			, Estatus = @Estatus
				
				OUTPUT
					
					  inserted.IdConfiguracionGeneral
					, inserted.Descripcion
					, inserted.Estatus
						
						INTO @ITEMS
							
							WHERE IdConfiguracionGeneral = @IdConfiguracionGeneral
END

SELECT * FROM @ITEMS